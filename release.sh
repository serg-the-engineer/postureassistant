#!/bin/bash

# =============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–µ–ª–∏–∑–∞ PostureAssistant
# –¥–ª—è macOS. (–í–µ—Ä—Å–∏—è 2.0 - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω DMG)
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: brew install create-dmg gh
# 2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ GitHub: gh auth login
# 3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–∑–¥–∞–π—Ç–µ —Ñ–æ–Ω assets/dmg-background.png
# 4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –Ω–æ–º–µ—Ä–æ–º –≤–µ—Ä—Å–∏–∏: ./release.sh v1.0.1
# =============================================================================

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
APP_NAME="PostureAssistant"
SPEC_FILE="${APP_NAME}.spec"
GITHUB_REPO="serg-the-engineer/postureassistant"
BACKGROUND_IMG="assets/dmg-background.png"

# --- –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ ---
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ---
if [ -z "$1" ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏!${NC}"
    echo "–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: ./release.sh v1.0.1"
    exit 1
fi
VERSION=$1

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ---
command -v pyinstaller >/dev/null 2>&1 || { echo -e "${RED}PyInstaller –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install pyinstaller${NC}"; exit 1; }
command -v create-dmg >/dev/null 2>&1 || { echo -e "${RED}create-dmg –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install create-dmg${NC}"; exit 1; }
command -v gh >/dev/null 2>&1 || { echo -e "${RED}GitHub CLI (gh) –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install gh${NC}"; exit 1; }

echo -e "${GREEN}>>> –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–±–æ—Ä–æ–∫...${NC}"
rm -rf dist build *.dmg

echo -e "${GREEN}>>> –®–∞–≥ 2: –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é PyInstaller...${NC}"
pyinstaller --noconfirm "$SPEC_FILE"
if [ $? -ne 0 ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ PyInstaller! –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.${NC}"
    exit 1
fi

APP_PATH="dist/${APP_NAME}.app"
DMG_NAME="${APP_NAME}-${VERSION}-macOS.dmg"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ .app —Ñ–∞–π–ª
if [ ! -d "$APP_PATH" ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: –§–∞–π–ª ${APP_PATH} –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏!${NC}"
    exit 1
fi

echo -e "${GREEN}>>> –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ .dmg –æ–±—Ä–∞–∑–∞...${NC}"

# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
# –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É create-dmg –ø–æ —á–∞—Å—Ç—è–º –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
CREATE_DMG_CMD=(
  create-dmg
  --volname "${APP_NAME} ${VERSION}"
  --window-pos 200 120
  --window-size 600 400
  --icon-size 100
  --icon "${APP_NAME}.app" 150 220
  --app-drop-link 450 220
)

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -f "$BACKGROUND_IMG" ]; then
  CREATE_DMG_CMD+=(--background "$BACKGROUND_IMG")
  echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: $BACKGROUND_IMG"
else
  echo "–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω DMG –±–µ–∑ —Ñ–æ–Ω–∞."
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É, —É–∫–∞–∑—ã–≤–∞—è –ò–°–¢–û–ß–ù–ò–ö –∫–∞–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π .app —Ñ–∞–π–ª, –∞ –Ω–µ –≤—Å—é –ø–∞–ø–∫—É dist
"${CREATE_DMG_CMD[@]}" "$DMG_NAME" "$APP_PATH"

if [ $? -ne 0 ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è .dmg! –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.${NC}"
    exit 1
fi

echo -e "${GREEN}>>> –®–∞–≥ 4: –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub...${NC}"
gh release create "$VERSION" \
    --repo "$GITHUB_REPO" \
    --title "Version ${VERSION}" \
    --notes "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è macOS." \
    --clobber \
    "$DMG_NAME"

if [ $? -ne 0 ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub! –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.${NC}"
    exit 1
fi

echo -e "\n${YELLOW}======================================================"
echo -e "    üéâ –†–ï–õ–ò–ó ${VERSION} –£–°–ü–ï–®–ù–û –û–ü–£–ë–õ–ò–ö–û–í–ê–ù! üéâ"
echo -e "======================================================${NC}"
echo "–§–∞–π–ª ${DMG_NAME} –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –≤–∞—à —Ä–µ–ª–∏–∑ –Ω–∞ GitHub."
echo "–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ: rm ${DMG_NAME}"